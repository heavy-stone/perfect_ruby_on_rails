name: Rails Tests
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    services:
      db:
        image: postgres:12.4
        env:
          POSTGRES_PASSWORD: password
    container:
      image: ruby:2.6.6
      env:
        RAILS_ENV: test

    steps:
      - uses: actions/checkout@v2
      - name: Set up
        run: |
          wget https://github.com/yarnpkg/yarn/releases/download/v1.22.5/yarn_1.22.5_all.deb
          dpkg -i yarn_1.22.5_all.deb
          rm yarn_1.22.5_all.deb
          curl -sL https://deb.nodesource.com/setup_12.x | bash -
          apt-get update -qq && apt-get install -y nodejs postgresql-client shared-mime-info
      - name: Build and test
        run: |
          bundle install --jobs 4 --retry 3
          bin/rails db:create
          bin/rails db:migrate
          bin/yarn install
          bin/rails test
          bin/rails test:system
